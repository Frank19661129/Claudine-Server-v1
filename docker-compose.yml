services:
  claudine-server:
    container_name: claudine-server
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8003:8000"  # Main server port (external:internal)
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://claudine:claudine_dev_password@claudine-postgres:5432/claudine_v1
      - DEBUG=true
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
    volumes:
      - ./app:/app/app  # Mount app directory for development hot-reload
    depends_on:
      - db-setup
    restart: unless-stopped
    networks:
      - postgres_network
      - mcp_network

  # Database setup service - runs once to create claudine_v1 database
  db-setup:
    image: postgres:15
    environment:
      - PGPASSWORD=claudine_dev_password
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for PostgreSQL...';
      until pg_isready -h claudine-postgres -U claudine; do
        sleep 1;
      done;
      echo 'PostgreSQL ready, checking/creating claudine_v1 database...';
      psql -h claudine-postgres -U claudine -tc \"SELECT 1 FROM pg_database WHERE datname = 'claudine_v1'\" | grep -q 1 ||
      psql -h claudine-postgres -U claudine -c 'CREATE DATABASE claudine_v1';
      echo 'Database claudine_v1 ready!';
      "
    networks:
      - postgres_network

networks:
  postgres_network:
    name: server-v0_claudine_network
    external: true
  mcp_network:
    name: claudine_claudine-mcp-network
    external: true

# Notes:
# - Uses existing claudine-postgres container from server-v0
# - Creates claudine_v1 database if it doesn't exist
# - Port 8003 for main server
# - Hot-reload enabled via volume mount for development
# - Connected to MCP network for communication with MCP servers
